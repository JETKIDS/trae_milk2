# 牛乳配達顧客管理システム 要件整理（2025年11月版）

## 1. 概要

- 対象利用者: 地域牛乳販売店の事務担当・配達担当
- 目的:
  - 顧客情報・配達パターン・臨時変更を一元管理し、日々の配達と月次請求を効率化する
  - 前月請求と当月入金の突合・繰越管理を明確にする
  - コース単位の一括入金処理を支援する
- 構成: React/TypeScript フロントエンド + Node.js/Express + SQLite バックエンド（`server/milk_delivery.db`）

## 2. ユースケース概要

| 利用者 | 主な目的 |
|--------|----------|
| 事務担当 | 顧客登録・情報更新、請求確定、入金登録、一括入金処理、帳票出力 |
| 配達担当 | 顧客別配達カレンダーの確認、臨時変更の把握 |

## 3. 機能要件

### 3.1 マスター情報
- 配達コース、スタッフ、メーカー、商品、会社情報を管理（初期データは DB 初期化スクリプトに含む）
- 商品マスタは税区分・単価・単位を保持し、React 側 `useProductMasters` フックで参照
- マスター更新は主にサーバー側スクリプトおよび API から実施

### 3.2 顧客管理
- 顧客基本情報: 名前・住所・電話・配達コース・担当者・契約開始日・備考
- 顧客 ID: 内部 ID（数値）と表示用 custom_id（7 桁）。画面表示は custom_id に統一
- 顧客編集: `CustomerDetail` 画面からモーダルで更新
- 口座振替情報を保持し、入金方法（集金/引き落し）と紐づけて管理

### 3.3 配達パターンと臨時変更
- 定期配達パターンを商品単位・曜日単位で管理
- `DeliveryPatternManager` でパターンの追加・終了日変更・単価改定を実施
- 臨時変更:
  - 特定日の本数変更、休配／休配解除、商品追加
  - `TemporaryChangeManager` で履歴を確認
- 操作は Undo スタックに登録され、直前操作を取り消し可能

### 3.4 配達カレンダー
- 顧客詳細の月次カレンダーで、商品×日付の数量・休配・解約マーカーを表示
- セルから臨時変更・解約・パターン編集を起動
- 確定済み月は背景色で識別し、編集をロック
- 月次集計では商品別数量・金額、消費税概算、繰越額を算出

### 3.5 請求および入金管理
- 請求確定:
  - 顧客単位で月次請求を確定 (`POST /api/customers/:id/invoices/confirm`)
  - `ar_invoices` に金額・繰越・確定日時を記録
  - 確定解除 (`POST /api/customers/:id/invoices/unconfirm`) に対応
- 繰越ロジック: 「前月請求額 - 当月入金額」を保持し、過入金はマイナス値として翌月に引き継ぐ
- 入金登録:
  - 顧客詳細の右メニューから当月入金を登録（集金/口座振替）
  - `ar_payments` に年/月単位で保存し、金額やメモを記録
- 請求書プレビュー:
  - 当月の配達カレンダーと商品別合計を 2up 帳票として表示
  - 前月請求／今月入金／過不足を明示

### 3.6 一括入金（集金／引き落し）
- `BulkCollection` 画面:
  - 対象入金月を選択（例: 10 月入金 → 9 月請求を参照）
  - コース単位または全コースを対象にできる
  - 「読み込み」ボタンで該当顧客・請求額・入金状況を取得（読み込み中はスピナー表示）
  - 残額の自動入力（Auto）または任意金額（Manual）で一括入金登録

### 3.7 帳票・その他機能
- インボイスプレビュー（印刷対応）
- 顧客別月次サマリー・商品集計
- 今後: コース別配送リストや売上ダッシュボードなどの追加を検討

## 4. 非機能・運用要件

### 4.1 パフォーマンス
- 顧客リストは仮想スクロールとデータキャッシュで描画を最適化
- API 応答は Express + SQLite（インデックス整備済み）でミリ秒単位を目標

### 4.2 信頼性
- Undo 機能により直前操作をロールバック可能
- 請求確定済み月は編集ロックし、データの整合性を確保

### 4.3 エラーハンドリング
- フロントエンドは共通 `useErrorHandler` で API エラーを捕捉し、ユーザーに通知
- バックエンドは Express ミドルウェアで統一レスポンスを返却

### 4.4 ID 取り扱いポリシー
- 画面表示は custom_id（7 桁ゼロ埋め）を採用
- 内部処理・外部キーは数値 customer_id を利用
- API 応答は custom_id と customer_id の両方を返却

### 4.5 データ更新・スクリプト
- `server/scripts` にマイグレーションやクレンジングスクリプトを配置
- 大量更新はスクリプトまたは API 経由で実施し、直接 SQL は避ける

### 4.6 運用環境
- Node.js 18+/npm
- 開発時: ルートで `npm run dev`（サーバー + クライアント同時起動）
- 本番: `server` を Node プロセスとして起動し、`client` ビルドを静的配信
- `server/milk_delivery.db` は定期バックアップを取得

## 5. 将来検討事項

- 口座振替 CSV 取込/出力の実装
- 配達員向けモバイル UI
- 認証・権限管理の導入（現状はシングルユーザー運用を想定）
- 売上ダッシュボード・コース別配送リストの拡充

---

本ドキュメントは 2025 年 11 月時点の実装を反映しています。仕様変更時は Pull Request に本書の更新を含め、運用担当の承認を得てください。