# 要件定義書

## はじめに

このドキュメントでは、牛乳屋さん（牛乳配達業者）のための顧客管理システムの要件を定義します。このシステムは、牛乳配達業者が顧客情報を管理し、配達スケジュールを最適化し、請求書を生成するのに役立ちます。システムの主な目的は、顧客が選択した商品とそのお届けパターンを直感的に管理し、効率的な配達業務を実現することです。

## 要件

### 要件 1: マスター情報管理

**ユーザーストーリー:** システム管理者として、システムの基本となるマスター情報を登録・管理したい。それにより、システム全体の正確な運用基盤を確立できる。

#### 受け入れ基準

1. WHEN マスター情報が登録される THEN システムは各マスター情報に一意のコードを自動的に割り当てる
2. WHEN 店舗情報の登録・更新が要求される THEN システムは店舗コードと基本情報（名称、住所、連絡先、営業時間など）を管理する
3. WHEN メーカー情報の登録・更新が要求される THEN システムはメーカーコードと仕入れ先情報を管理する
4. WHEN 配達コース情報の登録・更新が要求される THEN システムはコースコードと地域や効率に基づいた配達コース情報を設定・管理する
5. WHEN 配達員情報の登録・更新が要求される THEN システムは配達員コードと個人情報、担当コースを管理する
6. WHEN マスター情報が削除される THEN システムは関連データへの影響を確認し、安全に削除処理を行う
7. WHEN マスター情報一覧が要求される THEN システムは各マスター情報のコードと詳細情報を一覧表示する
8. WHEN マスター情報のコード体系が設定される THEN システムは業務に適したコード体系（数字のみ、英数字混在など）を選択できる
9. WHEN マスター情報がコードで検索される THEN システムはコードによる高速な検索と参照ができる

### 要件 2: 顧客情報管理

**ユーザーストーリー:** 牛乳配達業者として、顧客の情報を登録・更新・削除できるようにしたい。それにより、最新の顧客データを維持できる。

#### 受け入れ基準

1. WHEN 新しい顧客情報が入力される THEN システムは顧客コードを割り当て、顧客情報（名前、住所、連絡先、特別な要望など）を保存する
2. WHEN 顧客情報の更新が要求される THEN システムは既存の顧客情報を更新する
3. WHEN 顧客情報の削除が要求される THEN システムは確認後に顧客情報を削除する
4. WHEN 顧客情報が表示される THEN システムは名前、住所、連絡先、配達プラン、特別な要望を表示する
5. WHEN 顧客リストが要求される THEN システムは全ての顧客を一覧表示する
6. WHEN 顧客検索が実行される THEN システムは名前、住所、または電話番号で顧客を検索できる
7. WHEN 顧客管理画面が表示される THEN システムはカレンダー形式で顧客の配達スケジュールを視覚的に表示する
8. WHEN カレンダー上の日付が選択される THEN システムはその日の配達予定顧客と商品詳細を表示する
9. WHEN カレンダー上で顧客の配達スケジュールが変更される THEN システムはドラッグ＆ドロップ操作で簡単にスケジュール変更を反映する
10. WHEN 顧客のカレンダー画面で臨時変更が要求される THEN システムは直感的な操作で臨時の本数変更、曜日変更、お休み設定などを行える

### 要件 3: 商品選択と配達パターン設定

**ユーザーストーリー:** 牛乳配達業者として、顧客ごとに商品選択と配達パターンを設定したい。それにより、顧客の希望に合わせた正確な配達計画を立てられる。

#### 受け入れ基準

1. WHEN 顧客の商品選択画面が表示される THEN システムは利用可能な全商品リストから顧客が希望する商品を選択できる
2. WHEN 顧客が商品を選択する THEN システムは選択された各商品に対して配達パターンを設定できる
3. WHEN 顧客の配達パターンが入力される THEN システムは商品ごとに曜日別の配達数量を設定できる
4. WHEN 配達パターンが設定される THEN システムは「牛乳Aは月曜に3本・木曜に4本、ヨーグルトBは火曜のみ2個」などの商品別・曜日別パターンを登録できる
5. WHEN 配達パターンが変更される THEN システムは顧客の配達スケジュールを自動的に更新する
6. WHEN 配達パターンが表示される THEN システムは週間カレンダー形式で曜日ごと・商品ごとの配達内容を視覚的に表示する
7. WHEN 顧客の配達パターン設定が完了する THEN システムは自動的に適切な配達コースに顧客を割り当てる
8. WHEN 顧客の配達パターンを編集する THEN システムは直感的なインターフェースで簡単に変更できる
9. WHEN カレンダー上で臨時の本数変更が要求される THEN システムは通常の配達パターンを変更せずに特定日の配達数量を直感的な操作で変更できる
10. WHEN カレンダー上で臨時の曜日変更が要求される THEN システムはドラッグ＆ドロップ操作で配達日を別の日に簡単に移動できる
11. WHEN カレンダー上で臨時のお休み設定が要求される THEN システムはワンクリック操作で特定の日の配達をスキップする設定ができる
12. WHEN 臨時変更が設定される THEN システムは通常パターンとは別に臨時変更を色分けなどで視覚的に区別して表示する
13. WHEN カレンダー上で複数日の一括変更が要求される THEN システムは選択した複数日に対して同じ変更を一度に適用できる
14. WHEN 臨時変更の理由が入力される THEN システムは変更理由を記録し、配達リストや請求書に反映できる
13. WHEN 複数の顧客の配達パターンが設定される THEN システムは配達コースごとに顧客を自動的に振り分ける
14. WHEN 配達コースの割り当てが手動で変更される THEN システムは顧客の配達コースを更新する

### 要件 4: 配達スケジュール管理

**ユーザーストーリー:** 牛乳配達業者として、顧客ごとの配達スケジュールを設定・管理したい。それにより、効率的な配達ルートを計画できる。

#### 受け入れ基準

1. WHEN 新しい顧客が登録される THEN システムは顧客の配達スケジュールを設定できる
2. WHEN 配達スケジュールが更新される THEN システムは顧客の配達スケジュールを更新する
3. WHEN 日付が選択される THEN システムはその日の配達リストを表示する
4. WHEN 配達ルートが要求される THEN システムは効率的な配達順序を提案する
5. WHEN 顧客が一時的に配達停止を要求する THEN システムは指定された期間の配達をスケジュールから除外する
6. WHEN 特定の日付の配達リストが要求される THEN システムは配達すべき顧客と商品の詳細リストを生成する
7. WHEN 日別の宅配リストがコース別に要求される THEN システムは指定した日付の配達リストを配達コースごとに分けて表示する
8. WHEN コース別配達リストが印刷される THEN システムは各配達コースの効率的な配達順序で顧客リストを出力する
9. WHEN カレンダービューが表示される THEN システムは月間または週間の配達スケジュール全体を視覚的に表示する
10. WHEN 配達員がスケジュールを確認する THEN システムは配達員ごとの担当顧客と配達ルートを明確に表示する
11. WHEN 日別の宅配リスト出力が要求される THEN システムは指定日の宅配リストをコース別に出力する
12. WHEN コース別宅配リストが表示される THEN システムは配達順序に従って顧客と商品を整理して表示する
13. WHEN コース別宅配リストが印刷される THEN システムは配達員が使いやすい形式でリストを出力する
14. WHEN 日別の商品合計表が要求される THEN システムはコースごとに商品の合計数量を集計して表示する
15. WHEN 商品合計表が表示される THEN システムは商品カテゴリ別に整理して数量を表示する
16. WHEN 商品合計表が印刷される THEN システムは在庫管理や仕入れ計画に使いやすい形式で出力する
17. WHEN 日別の商品合計表が表示される THEN システムはコースごとの小計と全体の合計数を明確に表示する
18. WHEN 全体の商品合計が要求される THEN システムは全コースの商品数量を集計して総合計を表示する
19. WHEN メーカー別集計が要求される THEN システムは指定日の商品をメーカーごとに集計して表示する
20. WHEN 発注用レポートが要求される THEN システムはメーカーごとの必要商品数を集計した発注書を生成する
21. WHEN メーカー別集計が表示される THEN システムはメーカーごとの商品種類と数量を明確に表示する
22. WHEN 複数日の発注計画が要求される THEN システムは指定期間（週間・月間など）のメーカー別商品数量を予測して表示する
23. WHEN 発注履歴が要求される THEN システムはメーカー別の過去の発注履歴と実績を表示する
24. WHEN 発注書が印刷される THEN システムはメーカーごとに分かれた発注書を生成する

### 要件 5: 商品管理

**ユーザーストーリー:** 牛乳配達業者として、提供する商品（牛乳、ヨーグルト、チーズなど）を管理したい。それにより、在庫を追跡し、顧客に正確な商品を配達できる。

#### 受け入れ基準

1. WHEN 新しい商品が追加される THEN システムは商品コードを割り当て、商品情報（名称、価格、メーカー、カテゴリなど）を保存する
2. WHEN 商品情報が更新される THEN システムは既存の商品情報を更新する
3. WHEN 商品が削除される THEN システムは確認後に商品情報を削除する
4. WHEN 在庫レベルが設定された閾値を下回る THEN システムは警告を表示する
5. WHEN 商品リストが要求される THEN システムは全ての商品を一覧表示する
6. WHEN 顧客の注文が更新される THEN システムは必要な在庫数を更新する
7. WHEN 商品がメーカーと関連付けられる THEN システムは商品とメーカーの関係を管理する
8. WHEN 商品にメーカー情報が設定される THEN システムは発注管理のためにメーカーごとの商品を識別できる
9. WHEN 商品カテゴリが管理される THEN システムは商品を適切なカテゴリに分類する
10. WHEN 商品の発注単位が設定される THEN システムはメーカーごとの発注単位（ケース単位など）で数量を管理できる
11. WHEN 商品の発注リードタイムが設定される THEN システムは適切な発注タイミングを提案できる
12. WHEN 商品の最小発注数量が設定される THEN システムは発注時に最小数量を下回らないようにチェックする

### 要件 6: 請求書生成

**ユーザーストーリー:** 牛乳配達業者として、顧客ごとの請求書を生成したい。それにより、支払いの追跡と収益管理ができる。

#### 受け入れ基準

1. WHEN 月末が到来する THEN システムは各顧客の月間請求書を生成する
2. WHEN 請求書が生成される THEN システムは顧客ごとの配達履歴と金額を含める
3. WHEN 支払いが記録される THEN システムは顧客の支払い状況を更新する
4. WHEN 未払いの請求書がある THEN システムは支払い期限を過ぎた顧客のリストを表示する
5. WHEN 請求書が印刷される THEN システムは印刷用フォーマットで請求書を出力する
6. WHEN 電子請求書が要求される THEN システムはPDF形式で請求書を生成する

### 要件 7: レポート生成

**ユーザーストーリー:** 牛乳配達業者として、ビジネスの状況を把握するためのレポートを生成したい。それにより、経営判断や業務改善ができる。

#### 受け入れ基準

1. WHEN 売上レポートが要求される THEN システムは指定期間の売上データを表示する
2. WHEN 顧客分析が要求される THEN システムは顧客ごとの注文パターンと売上を表示する
3. WHEN 商品分析が要求される THEN システムは商品ごとの売上と人気度を表示する
4. WHEN 未払い分析が要求される THEN システムは未払い金額と顧客リストを表示する
5. WHEN レポートのエクスポートが要求される THEN システムはCSVまたはPDF形式でデータをエクスポートする

### 要件 8: システムセキュリティとアクセス制御

**ユーザーストーリー:** システム管理者として、ユーザーの役割に基づいてシステムへのアクセスを制御したい。それにより、データのセキュリティを確保できる。

#### 受け入れ基準

1. WHEN ユーザーがシステムにログインを試みる THEN システムはユーザー認証を実行する
2. WHEN 認証されていないユーザーが保護されたリソースにアクセスを試みる THEN システムはアクセスを拒否する
3. WHEN 管理者が新しいユーザーを作成する THEN システムはユーザーアカウントを登録する
4. WHEN 管理者がユーザーの権限を変更する THEN システムはユーザーの権限レベルを更新する
5. IF ユーザーが一定回数ログインに失敗する THEN システムはアカウントを一時的にロックする
6. WHEN ユーザーがパスワードをリセットする THEN システムは安全な方法で新しいパスワードを設定する

---

## 運用ポリシー: ID取り扱いの統一（顧客ID）

本システムでは、表示と内部処理の整合性・安全性を両立するため、以下の方針で顧客IDの取り扱いを統一します。

- 表示（フロントエンド）
  - 顧客IDの画面表示は原則として7桁の custom_id を使用する（ゼロ埋め7桁の数値文字列）。
  - 主要画面（顧客一覧、請求関連、集金、配達リスト、インボイスプレビュー等）は custom_id 表示に統一済み。
  - 必要に応じて DeliveryList の「IDリンク＋内部IDキャプション」（custom_id をリンク表示、内部の数値 id をキャプション表示）を共通コンポーネント化して適用拡大する（任意）。

- サーバー応答（バックエンド）
  - 顧客関連の各エンドポイントは id（数値の内部ID）と custom_id（7桁文字列）を可能な限り同梱して返す。
  - 期間API（配達リスト）等の配達関連応答にも custom_id を含める。

- 検索・並び替えの基準
  - 顧客一覧は custom_id 昇順（ASC）を標準とする。
  - 可能な限り custom_id を検索・ソートの基準として採用する。
  - 一方で、業務上の意味が強い並び（例：配達順 delivery_order）を優先する画面では従来通り delivery_order を優先する（コース別一覧・配達系）。

- 内部処理（整合性・性能重視）
  - 契約・休配・パターン・請求額計算・入金登録など、内部の参照整合性が必要な処理は customer_id（数値の内部ID）を維持して使用する。
  - custom_id はユーザーフレンドリーな表示用および検索キーとして扱い、内部の主キーは引き続き数値の id を使用する。

- API入力（拡張方針／任意）
  - 現状は安全性重視のため customer_id を入力の標準とする。
  - 利便性向上のため、必要に応じて custom_id 指定で参照できる補助API（例：GET /api/customers/custom/:customId）を追加する方針を採用可能（既存APIへの影響を最小化）。

- 一意性と生成規約
  - custom_id は顧客について7桁の数値文字列で一意となるように管理する。
  - 生成は既存の next-id ロジックにより未使用の最小値を採用し、ゼロ埋めで7桁表示する。

この方針により、ユーザー向けの分かりやすさ（7桁ID）と、既存ロジックの整合性・性能（内部ID）を両立します。