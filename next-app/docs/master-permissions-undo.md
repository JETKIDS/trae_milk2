# マスター変更の権限・Undo 要件メモ

## 1. 背景

マスター管理（コース・スタッフ・メーカー・会社情報・収納機関など）は運用上の影響が大きいため、Next.js + Supabase でも権限管理や変更履歴の扱いを整理する必要がある。

---

## 2. 権限レベル

| ロール案 | 権限 | 備考 |
|----------|------|------|
| 管理者 | 全てのマスター更新／削除 | デフォルト。将来的に Supabase Auth / RLS で管理 |
| オペレーター | 一部の参照のみ | 会社情報・収納機関などは閲覧のみ |
| ゲスト | 利用不可 | |

### 実装案
- Supabase Auth を導入する場合は `auth.uid()` を利用した RLS ルールを検討（現段階では未実装）。
- Next.js の Route Handler ではセッションや API キーでの保護を行い、後から権限チェックを追加できる構造にする。

---

## 3. Undo 対応

すでに導入済みの `undo_stack` を活用し、マスター変更の取り消しをサポートする。

| 操作 | 既存実装 | Undo 方針 |
|------|----------|-----------|
| コース更新・削除 | Route Handler に実装済み | `pushUndo` で変更前後を保存し、Undo API で復元／削除 |
| スタッフ更新・削除 | 既に `pushUndo` 未導入 | 同様に undo_stack を利用する（削除前のスタッフ情報、再割当情報を保持） |
| メーカー更新・削除 | 未導入 | 削除前のメーカー情報を `payload` に保存 |
| 会社情報更新 | 単一レコード | 更新前の `company_info` を保存 |
| 収納機関更新 | 単一レコード | 更新前の `institution_info` を保存 |

### Undo API 拡張

- `/api/customers/[id]/undo` に加え、マスター用の Undo API（例: `/api/masters/undo`）を追加するか検討。  
- あるいは `undo_stack` に `category` フィールドを追加し、共通 Undo API で処理を分岐。
- Undo 実行後は `rpc_update_customer_ledger` 等の再計算は不要だが、必要に応じてマスター一覧の再取得を行う。

---

## 4. ログ・監査

- 重要なマスター変更（会社情報・収納機関など）は操作ログ（誰がいつ変更したか）を保存する。  
- `metadata` フィールドに `user_id` や `reason` を記録する運用も検討。

---

## 5. TODO

- [ ] RLS/認証の導入を検討し、権限レベルを正式に決定。  
- [ ] マスター用 Undo API（または共通 Undo の拡張）を設計。  
- [ ] Route Handler に Undo 記録処理を追加し、UI から Undo を利用できるよう整備。  
- [ ] 操作ログ（操作者・タイムスタンプ）を記録する仕組みを検討。

---

## 6. 進捗メモ（2025-11）

- `master_undo_stack` テーブルと `rpc_push_master_undo` / `rpc_pop_master_undo` を追加済み。  
- `/api/masters/undo` でスタッフ／メーカー／コース／会社情報／収納機関の操作を取り消し可能。  
- Next.js `masters` ページに Undo ボタンを配置し、最新状態を再取得するフロント実装を追加。  
- 今後、認証導入後に操作者情報を `metadata` フィールドに記録することを検討する。

